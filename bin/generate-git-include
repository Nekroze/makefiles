#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "${BASH_SOURCE[0]}")/../include/common.bash"

# This script outputs Makefile syntax that defines the GIT_HEAD_xxx variables.

GIT_HEAD_HASH_FULL="$(git rev-parse --verify HEAD)"
GIT_HEAD_HASH="$(git rev-parse --short --verify HEAD)"
GIT_HEAD_BRANCH="$(git symbolic-ref --short HEAD 2>/dev/null || true)"
GIT_HEAD_TAG=
GIT_HEAD_COMMITTISH="$GIT_HEAD_HASH"

GIT_HEAD_SEMVER="0.0.0+$GIT_HEAD_HASH"
GIT_HEAD_SEMVER_MAJOR="0"
GIT_HEAD_SEMVER_MINOR="0"
GIT_HEAD_SEMVER_PATCH="0"
GIT_HEAD_SEMVER_PRERELEASE="$GIT_HEAD_HASH"
GIT_HEAD_SEMVER_METADATA=
GIT_HEAD_SEMVER_IS_STABLE=

if [ -n "$GIT_HEAD_BRANCH" ]; then
    GIT_HEAD_COMMITTISH="$GIT_HEAD_BRANCH"
else
    GIT_HEAD_TAG=$(git describe --tags --exact-match HEAD 2>/dev/null || true)

    if [ -n "$GIT_HEAD_TAG" ]; then
        GIT_HEAD_COMMITTISH="$GIT_HEAD_TAG"

        regex="^v?((0|[1-9][0-9]*)\\.(0|[1-9][0-9]*)\\.(0|[1-9][0-9]*)(\\-([0-9A-Za-z-]+(\\.[0-9A-Za-z-]+)*))?(\\+([0-9A-Za-z-]+(\\.[0-9A-Za-z-]+)*))?)$"

        if [[ "$GIT_HEAD_TAG" =~ $regex ]]; then
            GIT_HEAD_SEMVER=${BASH_REMATCH[1]}
            GIT_HEAD_SEMVER_MAJOR=${BASH_REMATCH[2]}
            GIT_HEAD_SEMVER_MINOR=${BASH_REMATCH[3]}
            GIT_HEAD_SEMVER_PATCH=${BASH_REMATCH[4]}
            GIT_HEAD_SEMVER_PRERELEASE=${BASH_REMATCH[6]}
            GIT_HEAD_SEMVER_METADATA=${BASH_REMATCH[9]}

            if [[ $GIT_HEAD_SEMVER_MAJOR > 0 && -z $GIT_HEAD_SEMVER_PRERELEASE ]]; then
                GIT_HEAD_SEMVER_IS_STABLE="true"
            fi
        fi
    fi
fi

echo "# DO NOT MODIFY"
echo "# This file was generated by the generate-git-include script."
echo
echo "GIT_HEAD_HASH_FULL ?= $GIT_HEAD_HASH_FULL"
echo "GIT_HEAD_HASH ?= $GIT_HEAD_HASH"
echo "GIT_HEAD_BRANCH ?= $GIT_HEAD_BRANCH"
echo "GIT_HEAD_TAG ?= $GIT_HEAD_TAG"
echo "GIT_HEAD_COMMITTISH ?= $GIT_HEAD_COMMITTISH"
echo "GIT_HEAD_SEMVER ?= $GIT_HEAD_SEMVER"
echo "GIT_HEAD_SEMVER_MAJOR ?= $GIT_HEAD_SEMVER_MAJOR"
echo "GIT_HEAD_SEMVER_MINOR ?= $GIT_HEAD_SEMVER_MINOR"
echo "GIT_HEAD_SEMVER_PATCH ?= $GIT_HEAD_SEMVER_PATCH"
echo "GIT_HEAD_SEMVER_PRERELEASE ?= $GIT_HEAD_SEMVER_PRERELEASE"
echo "GIT_HEAD_SEMVER_METADATA ?= $GIT_HEAD_SEMVER_METADATA"
echo "GIT_HEAD_SEMVER_IS_STABLE ?= $GIT_HEAD_SEMVER_IS_STABLE"
