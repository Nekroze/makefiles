#!/usr/bin/env bash
set -euo pipefail

# resolve the script name to the actual file on disk
file="${BASH_SOURCE[0]}"
while [ -h "$file" ]; do
    file="$(readlink "$file")"
done

export MF="$file"
export MF_VERSION="1"

if [ -n "${MF_ROOT:-}" ]; then
    if [[ "$MF_ROOT" != /* ]]; then
        2>&1 echo "MF_ROOT must be an absolute path"
        exit 1
    fi
else
    # If MF_ROOT is not set explicitly, then look for a ".makefiles" atom
    # in the directory name in order to locate the root.
    if [[ $file =~ ^(.+/.makefiles)/.+$ ]]; then
        export MF_ROOT="${BASH_REMATCH[1]}"
    else
        2>&1 echo "MF_ROOT is not defined and the root could not be determined automatically"
        exit 1
    fi
fi

"$MF_ROOT/lib/core/command/$1.bash" "${@:2}"
